"use strict";var X=Object.create;var C=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var O=(t,e)=>{for(var n in e)C(t,n,{get:e[n],enumerable:!0})},F=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ee(e))!ne.call(t,o)&&o!==n&&C(t,o,{get:()=>e[o],enumerable:!(s=Y(e,o))||s.enumerable});return t};var _=(t,e,n)=>(n=t!=null?X(te(t)):{},F(e||!t||!t.__esModule?C(n,"default",{value:t,enumerable:!0}):n,t)),oe=t=>F(C({},"__esModule",{value:!0}),t);var Me={};O(Me,{Bot:()=>E,BotSpecificClient:()=>I,Integration:()=>P,IntegrationDefinition:()=>b,IntegrationSpecificClient:()=>u,botIdHeader:()=>m,botUserIdHeader:()=>A,configurationHeader:()=>f,integrationIdHeader:()=>M,messages:()=>U,operationHeader:()=>h,parseBody:()=>p,serve:()=>y,typeHeader:()=>D,webhookIdHeader:()=>k});module.exports=oe(Me);var U={};O(U,{defaults:()=>de});var i=require("zod"),g=i.z.string().min(1),re=i.z.object({text:g}),se=i.z.object({markdown:g}),ae=i.z.object({imageUrl:g}),ie=i.z.object({audioUrl:g}),ge=i.z.object({videoUrl:g}),ce=i.z.object({fileUrl:g,title:g.optional()}),pe=i.z.object({latitude:i.z.number(),longitude:i.z.number(),address:i.z.string().optional(),title:i.z.string().optional()}),G=i.z.object({title:g,subtitle:g.optional(),imageUrl:g.optional(),actions:i.z.array(i.z.object({action:i.z.enum(["postback","url","say"]),label:g,value:g}))}),q=i.z.object({text:g,options:i.z.array(i.z.object({label:g,value:g}))}),le=i.z.object({items:i.z.array(G)}),de={text:{schema:re},markdown:{schema:se},image:{schema:ae},audio:{schema:ie},video:{schema:ge},file:{schema:ce},location:{schema:pe},carousel:{schema:le},card:{schema:G},dropdown:{schema:q},choice:{schema:q}};var m="x-bot-id",A="x-bot-user-id",M="x-integration-id",k="x-webhook-id",f="x-bp-configuration",h="x-bp-operation",D="x-bp-type";var K=require("node:http");var T=console;function p(t){if(!t.body)throw new Error("Missing body");return JSON.parse(t.body)}async function y(t,e=8072,n=me){let s=(0,K.createServer)(async(o,r)=>{try{let a=await Te(o);if(a.path==="/health"){r.writeHead(200).end("ok");return}let c=await t(a);r.writeHead(c?.status??200,c?.headers??{}).end(c?.body??"{}")}catch(a){T.error("Error while handling request",{error:a?.message??"Internal error occured"}),r.writeHead(500).end(JSON.stringify({error:a?.message??"Internal error occured"}))}});return s.listen(e,()=>n(e)),s}async function Te(t){let e=await Ie(t),n={};for(let o=0;o<t.rawHeaders.length;o+=2){let r=t.rawHeaders[o].toLowerCase(),a=t.rawHeaders[o+1];n[r]=a}let s=new URL(t.url??"",t.headers.host?`http://${t.headers.host}`:"http://botpress.cloud");return{body:e,path:s.pathname,query:ue(s.search,"?"),headers:n,method:t.method?.toUpperCase()??"GET"}}function ue(t,e){return t.indexOf(e)===0?t.slice(e.length):t}async function Ie(t){return new Promise((e,n)=>{if(t.method!=="POST"&&t.method!=="PUT"&&t.method!=="PATCH")return e(void 0);let s="";t.on("data",o=>s+=o.toString()),t.on("error",o=>n(o)),t.on("end",()=>e(s))})}function me(t){T.info(`Listening on port ${t}`)}var j=require("zod");var fe=j.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),L=t=>{let e=t[m],n=t[A],s=t[M],o=t[k],r=t[f],a=fe.parse(t[h]);if(!e)throw new Error("Missing bot headers");if(!n)throw new Error("Missing bot user headers");if(!s)throw new Error("Missing integration headers");if(!o)throw new Error("Missing webhook headers");if(!r)throw new Error("Missing configuration headers");if(!a)throw new Error("Missing operation headers");return{botId:e,botUserId:n,integrationId:s,webhookId:o,operation:a,configuration:r?JSON.parse(Buffer.from(r,"base64").toString("utf-8")):{}}};var b=class{name;version;title;description;icon;readme;configuration;events;actions;channels;states;user;secrets;identifier;constructor(e){let{name:n,version:s,icon:o,readme:r,title:a,description:c,configuration:d,events:l,actions:v,channels:B,states:R,user:w,secrets:Q,identifier:V}=e;this.name=n,this.version=s,this.icon=o,this.readme=r,this.title=a,this.identifier=V,this.description=c,this.configuration=d,this.events=l,this.actions=v,this.channels=B,this.states=R,this.user=w,this.secrets=Q}};var S=require("@botpress/client");var u=class{constructor(e){this.client=e}createConversation=e=>this.client.createConversation(e);getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);createEvent=e=>this.client.createEvent(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);createUser=e=>this.client.createUser(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);getOrCreateUser=e=>this.client.getOrCreateUser(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e);setState=e=>this.client.setState(e);patchState=e=>this.client.patchState(e);configureIntegration=e=>this.client.configureIntegration(e)};var H=_(require("util")),x=t=>{if(process.env.BP_LOG_FORMAT==="json")return JSON.stringify({msg:H.default.format(...t),visible_to_bot_owner:!0});{let[e,...n]=t;return H.default.format(`[For Bot Owner] ${e}`,...n)}},$={forBot:()=>({info:(...t)=>{console.info(x(t))},warn:(...t)=>{console.warn(x(t))},error:(...t)=>{console.error(x(t))},debug:(...t)=>{console.debug(x(t))}})};var N=t=>async e=>{let n=L(e.headers),s=new u(new S.Client({botId:n.botId,integrationId:n.integrationId})),o={ctx:n,req:e,client:s,logger:$,instance:t};try{let r;switch(n.operation){case"webhook_received":r=await ye(o);break;case"register":r=await ve(o);break;case"unregister":r=await Be(o);break;case"message_created":r=await xe(o);break;case"action_triggered":r=await Se(o);break;case"ping":r=await he(o);break;case"create_user":r=await Ce(o);break;case"create_conversation":r=await be(o);break;default:throw new Error(`Unknown operation ${n.operation}`)}return r?{...r,status:r.status??200}:{status:200}}catch(r){if(r instanceof S.RuntimeError)return{status:r.code,body:JSON.stringify(r.toJSON())};throw r}},he=async t=>{},ye=async({client:t,ctx:e,req:n,logger:s,instance:o})=>{let{req:r}=p(n);return o.webhook({client:t,ctx:e,req:r,logger:s})},ve=async({client:t,ctx:e,req:n,logger:s,instance:o})=>{if(!o.register)return;let{webhookUrl:r}=p(n);await o.register({client:t,ctx:e,webhookUrl:r,logger:s})},Be=async({client:t,ctx:e,req:n,logger:s,instance:o})=>{if(!o.unregister)return;let{webhookUrl:r}=p(n);await o.unregister({ctx:e,webhookUrl:r,client:t,logger:s})},Ce=async({client:t,ctx:e,req:n,logger:s,instance:o})=>{if(!o.createUser)return;let{tags:r}=p(n);return await o.createUser({ctx:e,client:t,tags:r,logger:s})},be=async({client:t,ctx:e,req:n,logger:s,instance:o})=>{if(!o.createConversation)return;let{channel:r,tags:a}=p(n);return await o.createConversation({ctx:e,client:t,channel:r,tags:a,logger:s})},xe=async({ctx:t,req:e,client:n,logger:s,instance:o})=>{let{conversation:r,user:a,type:c,payload:d,message:l}=p(e),v=o.channels[r.channel];if(!v)throw new Error(`Channel ${r.channel} not found`);let B=v.messages[c];if(!B)throw new Error(`Message of type ${c} not found in channel ${r.channel}`);await B({ctx:t,conversation:r,message:l,user:a,type:c,client:n,payload:d,ack:async({tags:w})=>{await n.updateMessage({id:l.id,tags:w})},logger:s})},Se=async({req:t,ctx:e,client:n,logger:s,instance:o})=>{let{input:r,type:a}=p(t);if(!a)throw new Error("Missing action type");let c=o.actions[a];if(!c)throw new Error(`Action ${a} not found`);let d=await c({ctx:e,input:r,client:n,type:a,logger:s});return{body:JSON.stringify({output:d})}};var P=class{props;actions;channels;register;unregister;createUser;createConversation;webhook;constructor(e){this.props=e,this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}handler=N(this);start=e=>y(this.handler,e)};var Z=_(require("@botpress/client"));var I=class{constructor(e){this.client=e}getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);createEvent=e=>this.client.createEvent(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));setState=e=>this.client.setState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));patchState=e=>this.client.patchState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));callAction=e=>this.client.callAction(e);createConversation=e=>this.client.createConversation(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);createUser=e=>this.client.createUser(e);getOrCreateUser=e=>this.client.getOrCreateUser(e)};var W=require("zod");var Pe=W.z.enum(["event_received","register","unregister","ping"]),z=t=>{let e=t[m],n=t[f],s=t[D],o=Pe.parse(t[h]);if(!e)throw new Error("Missing bot headers");if(!s)throw new Error("Missing type headers");if(!n)throw new Error("Missing configuration headers");if(!o)throw new Error("Missing operation headers");return{botId:e,operation:o,type:s,configuration:n?JSON.parse(Buffer.from(n,"base64").toString("utf-8")):{}}};var J=t=>async e=>{let n=z(e.headers);n.operation!=="ping"&&T.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`);let s=new I(new Z.Client({botId:n.botId})),o={req:e,ctx:n,client:s,instance:t};switch(n.operation){case"event_received":await Ae(o);break;case"register":await we(o);break;case"unregister":await Ue(o);break;case"ping":await Ee(o);break;default:throw new Error(`Unknown operation ${n.operation}`)}return{status:200}},Ee=async t=>{},we=async t=>{},Ue=async t=>{},Ae=async({ctx:t,req:e,client:n,instance:s})=>{T.debug(`Received event ${t.type}`);let o=p(e),r=o.event;switch(t.type){case"message_created":let a={user:r.payload.user,conversation:r.payload.conversation,message:r.payload.message,states:r.payload.states,event:r};await Promise.all(s.messageHandlers.map(l=>l({client:n,ctx:t,...a})));break;case"state_expired":let c={state:r.payload.state};await Promise.all(s.stateExpiredHandlers.map(l=>l({client:n,ctx:t,...c})));break;default:let d={event:o.event};await Promise.all(s.eventHandlers.map(l=>l({client:n,ctx:t,...d})))}};var E=class{_state={messageHandlers:[],eventHandlers:[],stateExpiredHandlers:[]};props;constructor(e){this.props=e}message=e=>{this._state.messageHandlers.push(e)};event=e=>{this._state.eventHandlers.push(e)};stateExpired=e=>{this._state.stateExpiredHandlers.push(e)};handler=J(this._state);start=e=>y(this.handler,e)};0&&(module.exports={Bot,BotSpecificClient,Integration,IntegrationDefinition,IntegrationSpecificClient,botIdHeader,botUserIdHeader,configurationHeader,integrationIdHeader,messages,operationHeader,parseBody,serve,typeHeader,webhookIdHeader});
//# sourceMappingURL=index.js.map
